
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>spring中redis的使用 &#8212; stest  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="springredis">
<h1>spring中redis的使用<a class="headerlink" href="#springredis" title="Permalink to this headline">¶</a></h1>
<div class="section" id="springbootredis">
<h2>在springboot中用redis实现消息队列<a class="headerlink" href="#springbootredis" title="Permalink to this headline">¶</a></h2>
<div class="section" id="redis">
<h3>安装redis服务端<a class="headerlink" href="#redis" title="Permalink to this headline">¶</a></h3>
<p>略</p>
</div>
<div class="section" id="pom">
<h3>POM<a class="headerlink" href="#pom" title="Permalink to this headline">¶</a></h3>
<div class="code java highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="n">springframework</span><span class="o">.</span><span class="n">boot</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">redis</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h3>创建一个消息接收者<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="code java highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">hello</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.CountDownLatch</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="p">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">Receiver</span> <span class="p">{</span>
    <span class="n">private</span> <span class="n">static</span> <span class="n">final</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">Receiver</span><span class="o">.</span><span class="n">class</span><span class="p">);</span>

    <span class="n">private</span> <span class="n">CountDownLatch</span> <span class="n">latch</span><span class="p">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">public</span> <span class="n">Receiver</span><span class="p">(</span><span class="n">CountDownLatch</span> <span class="n">latch</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">this</span><span class="o">.</span><span class="n">latch</span> <span class="o">=</span> <span class="n">latch</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">void</span> <span class="n">receiveMessage</span><span class="p">(</span><span class="n">String</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received &lt;&quot;</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">);</span>
        <span class="n">latch</span><span class="o">.</span><span class="n">countDown</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>注册监听者并发送消息<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Spring Data Redis provides all the components you need to send and receive messages with Redis. Specifically, you need to configure:</p>
<blockquote>
<div><ul class="simple">
<li>A connection factory</li>
<li>A message listener container</li>
<li>A Redis template</li>
</ul>
</div></blockquote>
<p>You’ll use the Redis template to send messages and you will register the Receiver with the message listener container so that it will receive messages. The connection factory drives both the template and the message listener container, enabling them to connect to the Redis server.</p>
<p>This example uses Spring Boot’s default RedisConnectionFactory, an instance of JedisConnectionFactory which is based on the Jedis Redis library. The connection factory is injected into both the message listener container and the Redis template.</p>
<div class="code java highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">hello</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.CountDownLatch</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationContext</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.connection.RedisConnectionFactory</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.core.StringRedisTemplate</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.listener.PatternTopic</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.listener.RedisMessageListenerContainer</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.listener.adapter.MessageListenerAdapter</span><span class="p">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">Application</span> <span class="p">{</span>

    <span class="n">private</span> <span class="n">static</span> <span class="n">final</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">Application</span><span class="o">.</span><span class="n">class</span><span class="p">);</span>

    <span class="nd">@Bean</span>
    <span class="n">RedisMessageListenerContainer</span> <span class="n">container</span><span class="p">(</span><span class="n">RedisConnectionFactory</span> <span class="n">connectionFactory</span><span class="p">,</span>
            <span class="n">MessageListenerAdapter</span> <span class="n">listenerAdapter</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">RedisMessageListenerContainer</span> <span class="n">container</span> <span class="o">=</span> <span class="n">new</span> <span class="n">RedisMessageListenerContainer</span><span class="p">();</span>
        <span class="n">container</span><span class="o">.</span><span class="n">setConnectionFactory</span><span class="p">(</span><span class="n">connectionFactory</span><span class="p">);</span>
        <span class="n">container</span><span class="o">.</span><span class="n">addMessageListener</span><span class="p">(</span><span class="n">listenerAdapter</span><span class="p">,</span> <span class="n">new</span> <span class="n">PatternTopic</span><span class="p">(</span><span class="s2">&quot;chat&quot;</span><span class="p">));</span>

        <span class="k">return</span> <span class="n">container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span>
    <span class="n">MessageListenerAdapter</span> <span class="n">listenerAdapter</span><span class="p">(</span><span class="n">Receiver</span> <span class="n">receiver</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">new</span> <span class="n">MessageListenerAdapter</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="s2">&quot;receiveMessage&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span>
    <span class="n">Receiver</span> <span class="n">receiver</span><span class="p">(</span><span class="n">CountDownLatch</span> <span class="n">latch</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">new</span> <span class="n">Receiver</span><span class="p">(</span><span class="n">latch</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span>
    <span class="n">CountDownLatch</span> <span class="n">latch</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">new</span> <span class="n">CountDownLatch</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span>
    <span class="n">StringRedisTemplate</span> <span class="n">template</span><span class="p">(</span><span class="n">RedisConnectionFactory</span> <span class="n">connectionFactory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">new</span> <span class="n">StringRedisTemplate</span><span class="p">(</span><span class="n">connectionFactory</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="n">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>

        <span class="n">ApplicationContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">SpringApplication</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Application</span><span class="o">.</span><span class="n">class</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>

        <span class="n">StringRedisTemplate</span> <span class="n">template</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">getBean</span><span class="p">(</span><span class="n">StringRedisTemplate</span><span class="o">.</span><span class="n">class</span><span class="p">);</span>
        <span class="n">CountDownLatch</span> <span class="n">latch</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">getBean</span><span class="p">(</span><span class="n">CountDownLatch</span><span class="o">.</span><span class="n">class</span><span class="p">);</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sending message...&quot;</span><span class="p">);</span>
        <span class="n">template</span><span class="o">.</span><span class="n">convertAndSend</span><span class="p">(</span><span class="s2">&quot;chat&quot;</span><span class="p">,</span> <span class="s2">&quot;Hello from Redis!&quot;</span><span class="p">);</span>

        <span class="n">latch</span><span class="o">.</span><span class="k">await</span><span class="p">();</span>

        <span class="n">System</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The bean defined in the listenerAdapter method is registered as a message listener in the message listener container defined in container and will listen for messages on the “chat” topic. Because the Receiver class is a POJO, it needs to be wrapped in a message listener adapter that implements the MessageListener interface required by addMessageListener(). The message listener adapter is also configured to call the receiveMessage() method on Receiver when a message arrives.</p>
<p>The connection factory and message listener container beans are all you need to listen for messages. To send a message you also need a Redis template. Here, it is a bean configured as a StringRedisTemplate, an implementation of RedisTemplate that is focused on the common use of Redis where both keys and values are <a href="#id3"><span class="problematic" id="id4">`</span></a>String`s.</p>
<p>The main() method kicks everything off by creating a Spring application context. The application context then starts the message listener container, and the message listener container bean starts listening for messages. The main() method then retrieves the StringRedisTemplate bean from the application context and uses it to send a “Hello from Redis!” message on the “chat” topic. Finally, it closes the Spring application context and the application ends.</p>
</div>
</div>
<div class="section" id="id5">
<h2>redis缓存的使用<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>Redis是目前业界使用最广泛的内存数据存储。相比memcached，Redis支持更丰富的数据结构，例如hashes, lists, sets等，同时支持数据持久化。除此之外，Redis还提供一些类数据库的特性，比如事务，HA，主从库。可以说Redis兼具了缓存系统和数据库的一些特性，因此有着丰富的应用场景。本文介绍Redis在Spring Boot中两个典型的应用场景。</p>
<div class="section" id="id6">
<h3>POM<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>略</p>
</div>
<div class="section" id="properties">
<h3>PROPERTIES<a class="headerlink" href="#properties" title="Permalink to this headline">¶</a></h3>
<div class="code java highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># REDIS (RedisProperties)</span>
<span class="c1"># Redis数据库索引（默认为0）</span>
<span class="n">spring</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">database</span><span class="o">=</span><span class="mi">0</span>
<span class="c1"># Redis服务器地址</span>
<span class="n">spring</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">host</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">0.58</span>
<span class="c1"># Redis服务器连接端口</span>
<span class="n">spring</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">port</span><span class="o">=</span><span class="mi">6379</span>
<span class="c1"># Redis服务器连接密码（默认为空）</span>
<span class="n">spring</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">password</span><span class="o">=</span>
<span class="c1"># 连接池最大连接数（使用负值表示没有限制）</span>
<span class="n">spring</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">max</span><span class="o">-</span><span class="n">active</span><span class="o">=</span><span class="mi">8</span>
<span class="c1"># 连接池最大阻塞等待时间（使用负值表示没有限制）</span>
<span class="n">spring</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">max</span><span class="o">-</span><span class="n">wait</span><span class="o">=-</span><span class="mi">1</span>
<span class="c1"># 连接池中的最大空闲连接</span>
<span class="n">spring</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">max</span><span class="o">-</span><span class="n">idle</span><span class="o">=</span><span class="mi">8</span>
<span class="c1"># 连接池中的最小空闲连接</span>
<span class="n">spring</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">min</span><span class="o">-</span><span class="n">idle</span><span class="o">=</span><span class="mi">0</span>
<span class="c1"># 连接超时时间（毫秒）</span>
<span class="n">spring</span><span class="o">.</span><span class="n">redis</span><span class="o">.</span><span class="n">timeout</span><span class="o">=</span><span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="section" id="cache">
<h3>添加cache的配置类<a class="headerlink" href="#cache" title="Permalink to this headline">¶</a></h3>
<div class="code java highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@Configuration</span>
<span class="nd">@EnableCaching</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">RedisConfig</span> <span class="n">extends</span> <span class="n">CachingConfigurerSupport</span><span class="p">{</span>

    <span class="nd">@Bean</span>
    <span class="n">public</span> <span class="n">KeyGenerator</span> <span class="n">keyGenerator</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">new</span> <span class="n">KeyGenerator</span><span class="p">()</span> <span class="p">{</span>
            <span class="nd">@Override</span>
            <span class="n">public</span> <span class="n">Object</span> <span class="n">generate</span><span class="p">(</span><span class="n">Object</span> <span class="n">target</span><span class="p">,</span> <span class="n">Method</span> <span class="n">method</span><span class="p">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">params</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="n">new</span> <span class="n">StringBuilder</span><span class="p">();</span>
                <span class="n">sb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">getName</span><span class="p">());</span>
                <span class="n">sb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">getName</span><span class="p">());</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">Object</span> <span class="n">obj</span> <span class="p">:</span> <span class="n">params</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">sb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">toString</span><span class="p">());</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="n">toString</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s2">&quot;rawtypes&quot;</span><span class="p">)</span>
    <span class="nd">@Bean</span>
    <span class="n">public</span> <span class="n">CacheManager</span> <span class="n">cacheManager</span><span class="p">(</span><span class="n">RedisTemplate</span> <span class="n">redisTemplate</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">RedisCacheManager</span> <span class="n">rcm</span> <span class="o">=</span> <span class="n">new</span> <span class="n">RedisCacheManager</span><span class="p">(</span><span class="n">redisTemplate</span><span class="p">);</span>
        <span class="o">//</span><span class="n">设置缓存过期时间</span>
        <span class="o">//</span><span class="n">rcm</span><span class="o">.</span><span class="n">setDefaultExpiration</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span><span class="o">//</span><span class="n">秒</span>
        <span class="k">return</span> <span class="n">rcm</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nd">@Bean</span>
    <span class="n">public</span> <span class="n">RedisTemplate</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">redisTemplate</span><span class="p">(</span><span class="n">RedisConnectionFactory</span> <span class="n">factory</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">StringRedisTemplate</span> <span class="n">template</span> <span class="o">=</span> <span class="n">new</span> <span class="n">StringRedisTemplate</span><span class="p">(</span><span class="n">factory</span><span class="p">);</span>
        <span class="n">Jackson2JsonRedisSerializer</span> <span class="n">jackson2JsonRedisSerializer</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Jackson2JsonRedisSerializer</span><span class="p">(</span><span class="n">Object</span><span class="o">.</span><span class="n">class</span><span class="p">);</span>
        <span class="n">ObjectMapper</span> <span class="n">om</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ObjectMapper</span><span class="p">();</span>
        <span class="n">om</span><span class="o">.</span><span class="n">setVisibility</span><span class="p">(</span><span class="n">PropertyAccessor</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="n">JsonAutoDetect</span><span class="o">.</span><span class="n">Visibility</span><span class="o">.</span><span class="n">ANY</span><span class="p">);</span>
        <span class="n">om</span><span class="o">.</span><span class="n">enableDefaultTyping</span><span class="p">(</span><span class="n">ObjectMapper</span><span class="o">.</span><span class="n">DefaultTyping</span><span class="o">.</span><span class="n">NON_FINAL</span><span class="p">);</span>
        <span class="n">jackson2JsonRedisSerializer</span><span class="o">.</span><span class="n">setObjectMapper</span><span class="p">(</span><span class="n">om</span><span class="p">);</span>
        <span class="n">template</span><span class="o">.</span><span class="n">setValueSerializer</span><span class="p">(</span><span class="n">jackson2JsonRedisSerializer</span><span class="p">);</span>
        <span class="n">template</span><span class="o">.</span><span class="n">afterPropertiesSet</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">template</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<p>好了，接下来就可以直接使用了</p>
<div class="code java highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@RunWith</span><span class="p">(</span><span class="n">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="n">class</span><span class="p">)</span>
<span class="nd">@SpringApplicationConfiguration</span><span class="p">(</span><span class="n">Application</span><span class="o">.</span><span class="n">class</span><span class="p">)</span>
<span class="n">public</span> <span class="k">class</span> <span class="nc">TestRedis</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">private</span> <span class="n">StringRedisTemplate</span> <span class="n">stringRedisTemplate</span><span class="p">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">private</span> <span class="n">RedisTemplate</span> <span class="n">redisTemplate</span><span class="p">;</span>

    <span class="nd">@Test</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">test</span><span class="p">()</span> <span class="n">throws</span> <span class="ne">Exception</span> <span class="p">{</span>
        <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="n">opsForValue</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;aaa&quot;</span><span class="p">,</span> <span class="s2">&quot;111&quot;</span><span class="p">);</span>
        <span class="n">Assert</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="s2">&quot;111&quot;</span><span class="p">,</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="n">opsForValue</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;aaa&quot;</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="n">public</span> <span class="n">void</span> <span class="n">testObj</span><span class="p">()</span> <span class="n">throws</span> <span class="ne">Exception</span> <span class="p">{</span>
        <span class="n">User</span> <span class="n">user</span><span class="o">=</span><span class="n">new</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;aa@126.com&quot;</span><span class="p">,</span> <span class="s2">&quot;aa&quot;</span><span class="p">,</span> <span class="s2">&quot;aa123456&quot;</span><span class="p">,</span> <span class="s2">&quot;aa&quot;</span><span class="p">,</span><span class="s2">&quot;123&quot;</span><span class="p">);</span>
        <span class="n">ValueOperations</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="n">operations</span><span class="o">=</span><span class="n">redisTemplate</span><span class="o">.</span><span class="n">opsForValue</span><span class="p">();</span>
        <span class="n">operations</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;com.neox&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span>
        <span class="n">operations</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;com.neo.f&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">TimeUnit</span><span class="o">.</span><span class="n">SECONDS</span><span class="p">);</span>
        <span class="n">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
        <span class="o">//</span><span class="n">redisTemplate</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;com.neo.f&quot;</span><span class="p">);</span>
        <span class="n">boolean</span> <span class="n">exists</span><span class="o">=</span><span class="n">redisTemplate</span><span class="o">.</span><span class="n">hasKey</span><span class="p">(</span><span class="s2">&quot;com.neo.f&quot;</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">exists</span><span class="p">){</span>
            <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;exists is true&quot;</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;exists is false&quot;</span><span class="p">);</span>
        <span class="p">}</span>
       <span class="o">//</span> <span class="n">Assert</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="s2">&quot;aa&quot;</span><span class="p">,</span> <span class="n">operations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;com.neo.f&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getUserName</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>以上都是手动使用的方式，如何在查找数据库的时候自动使用缓存呢，看下面；</p>
<p>4、自动根据方法生成缓存</p>
<div class="code java highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s2">&quot;/getUser&quot;</span><span class="p">)</span>
<span class="nd">@Cacheable</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;user-key&quot;</span><span class="p">)</span>
<span class="n">public</span> <span class="n">User</span> <span class="n">getUser</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">User</span> <span class="n">user</span><span class="o">=</span><span class="n">userRepository</span><span class="o">.</span><span class="n">findByUserName</span><span class="p">(</span><span class="s2">&quot;aa&quot;</span><span class="p">);</span>
    <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;若下面没出现“无缓存的时候调用”字样且能打印出数据表示测试成功&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">user</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>其中value的值就是缓存到redis中的key</p>
</div>
</div>
<div class="section" id="session-spring-session-data-redis">
<h2>共享Session-spring-session-data-redis<a class="headerlink" href="#session-spring-session-data-redis" title="Permalink to this headline">¶</a></h2>
<p>分布式系统中，sessiong共享有很多的解决方案，其中托管到缓存中应该是最常用的方案之一，</p>
<p>Spring Session官方说明</p>
<p>Spring Session provides an API and implementations for managing a user’s session information.
如何使用</p>
<div class="section" id="id7">
<h3>1、引入依赖<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<div class="code java highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="o">.</span><span class="n">springframework</span><span class="o">.</span><span class="n">session</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">session</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">redis</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="session">
<h3>2、Session配置：<a class="headerlink" href="#session" title="Permalink to this headline">¶</a></h3>
<div class="code java highlight-default notranslate"><div class="highlight"><pre><span></span>@Configuration
@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 86400*30)
public class SessionConfig {
}

maxInactiveIntervalInSeconds: 设置Session失效时间，使用Redis Session之后，原Boot的server.session.timeout属性不再生效
</pre></div>
</div>
<p>好了，这样就配置好了，我们来测试一下</p>
<p>3、测试</p>
<p>添加测试方法获取sessionid</p>
<div class="code java highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s2">&quot;/uid&quot;</span><span class="p">)</span>
    <span class="n">String</span> <span class="n">uid</span><span class="p">(</span><span class="n">HttpSession</span> <span class="n">session</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">UUID</span> <span class="n">uid</span> <span class="o">=</span> <span class="p">(</span><span class="n">UUID</span><span class="p">)</span> <span class="n">session</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">uid</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="n">randomUUID</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">session</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">,</span> <span class="n">uid</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">getId</span><span class="p">();</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>登录redis 输入 keys ‘<em>sessions</em>’</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">t</span><span class="o">&lt;</span><span class="n">spring</span><span class="p">:</span><span class="n">session</span><span class="p">:</span><span class="n">sessions</span><span class="p">:</span><span class="n">db031986</span><span class="o">-</span><span class="mi">8</span><span class="n">ecc</span><span class="o">-</span><span class="mi">48</span><span class="n">d6</span><span class="o">-</span><span class="n">b471</span><span class="o">-</span><span class="n">b137a3ed6bc4</span>
<span class="n">t</span><span class="p">(</span><span class="n">spring</span><span class="p">:</span><span class="n">session</span><span class="p">:</span><span class="n">expirations</span><span class="p">:</span><span class="mi">1472976480000</span>
</pre></div>
</div>
<p>其中 1472976480000为失效时间，意思是这个时间后session失效，db031986-8ecc-48d6-b471-b137a3ed6bc4 为sessionId,登录http://localhost:8080/uid 发现会一致，就说明session 已经在redis里面进行有效的管理了。
如何在两台或者多台中共享session</p>
<p>其实就是按照上面的步骤在另一个项目中再次配置一次，启动后自动就进行了session共享。</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="id8">
<h2>参考<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://spring.io/guides/gs/messaging-redis/">Messaging with Redis</a></p>
<p><a class="reference external" href="https://blog.csdn.net/forezp/article/details/71023652">在springboot中用redis实现消息队列</a></p>
<p><a class="reference external" href="http://www.cnblogs.com/ityouknow/p/5748830.html">纯洁的微笑–spring boot(三)：Spring Boot中Redis的使用</a></p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">spring中redis的使用</a><ul>
<li><a class="reference internal" href="#springbootredis">在springboot中用redis实现消息队列</a><ul>
<li><a class="reference internal" href="#redis">安装redis服务端</a></li>
<li><a class="reference internal" href="#pom">POM</a></li>
<li><a class="reference internal" href="#id1">创建一个消息接收者</a></li>
<li><a class="reference internal" href="#id2">注册监听者并发送消息</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5">redis缓存的使用</a><ul>
<li><a class="reference internal" href="#id6">POM</a></li>
<li><a class="reference internal" href="#properties">PROPERTIES</a></li>
<li><a class="reference internal" href="#cache">添加cache的配置类</a></li>
</ul>
</li>
<li><a class="reference internal" href="#session-spring-session-data-redis">共享Session-spring-session-data-redis</a><ul>
<li><a class="reference internal" href="#id7">1、引入依赖</a></li>
<li><a class="reference internal" href="#session">2、Session配置：</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8">参考</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/microservice/springboot/8_messaging_with_redis.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, wenchaofu.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../../_sources/microservice/springboot/8_messaging_with_redis.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>